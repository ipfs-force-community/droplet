# Migrating Deals

When migrating from `lotus` to `venus`, it is necessary to migrate deals that have completed sealing proofs and those still in the `StorageDealWaitingForData` state.
This document mainly introduces how to migrate deals from `lotus-miner` and `boost` to `droplet`.

## Prerequisites

To complete the deal migration, the following two conditions must be met:
- Already have a set of `venus` chain services with the `droplet` component.
- The miner account has been migrated into the `venus` chain services.

## Migrating Deals from lotus-miner

### Exporting Deals from lotus-miner

Export deals through the API, refer to the following example:

> `TOKEN` is the token for `lotus-miner`, which can be generated using the command: `lotus-miner auth api-info --perm=admin`

```bash
curl http://127.0.0.1:2345/rpc/v0 -X POST \
-H "Content-Type: application/json" \
-H "Authorization: Bearer <TOKEN>" \
-d '{"method": "Filecoin.MarketListIncompleteDeals","params":[], "id": 0}' > lotus_miner_deals.json
```

After executing the command, you may get the following result:

```
{"jsonrpc":"2.0","result":[{"Proposal":{"PieceCID":{"/":"baga6ea4seaqcrddjqzqavqipgljq6jn3bmbnhzw5yucdmoqoji3tni6kisjqini"},"PieceSize":128,"VerifiedDeal":false,"Client":"t3r3nyp4sitvilwc5wggvrsyoqmue3zgliqsqzqxri5up2fmlx2e5xeltxv4qbokjj6qrdgz3t7zdwygogpjaa","Provider":"t01000","Label":"uAVUAHOi_meaYr-eUqOadpea1i-ivleeahOaVsOaNrgo","StartEpoch":173482,"EndEpoch":694737,"StoragePricePerEpoch":"0",
......
":"bafkqahhix6m6ngfp46kkrzu5uxtllc7iv6k6pgue42k3bzunvyfa"},"PieceCid":{"/":"baga6ea4seaqcrddjqzqavqipgljq6jn3bmbnhzw5yucdmoqoji3tni6kisjqini"},"PieceSize":127,"RawBlockSize":0},"AvailableForRetrieval":false,"DealID":0,"CreationTime":"2022-08-03T10:35:09.774748628+08:00","TransferChannelId":null,"SectorNumber":0,"InboundCAR":""}],"id":0}
```

Among them, each item in `result` is the detailed information of a deal. The `State` field in each deal represents the current state of the deal. If `State` = 18, it indicates that the current deal is in the `StorageDealWaitingForData` state.

### Importing Deals into `droplet`

Before starting to import deals, confirm whether the miner account is in the `venus` chain services. If not, migrate the miner account into the `venus` chain services.

```bash
./droplet actor list
```

After confirming the miner, you can directly import the deals in `droplet` using the command:
    
```bash
./droplet storage deal import-deal lotus_miner_deals.json

# Result
import 2 deals success
```

## Migrating Deals from boost

### Exporting Deals from boost

Boost supports two deal placement protocols, temporarily referred to as old and new protocols. Users may have used both protocols when placing deals, so deals need to be exported in two steps.

#### Exporting Old Protocol Deals

Export deals through the API, similar to exporting from `lotus-miner`, refer to the example:

> `TOKEN` is the token generated by `boost`, which can be generated using the command `./boostd auth create-token --perm admin`.

```bash
curl http://127.0.0.1:1288/rpc/v0 -X POST \
-H "Content-Type: application/json" \
-H "Authorization: Bearer <TOKEN>" \
-d '{"method": "Filecoin.MarketListIncompleteDeals","params":[], "id": 0}' > boost_old_deals.json
```

#### Exporting New Protocol Deals

1. First, determine how many deals there are

```bash
curl -X POST -H "Content-Type: application/json" -d '{"query":"query { dealsCount() }"}' http://localhost:8080/graphql/query | jq

# Result

{
  "data": {
    "dealsCount": 2
  }
}
```

The value of `dealsCount` in the returned result is the number of existing deals.

2. Export all deals

> In the query below, the value of the `limit` field is 10000000, which can retrieve up to 10000000 deals, and it needs to be greater than the number of existing deals.

```bash
curl -X POST \
-H "Content-Type: application/json" \
-d '{"query":"query { deals(limit: 10000000) { totalCount deals { ID ClientAddress ProviderAddress CreatedAt PieceCid PieceSize IsVerified ProposalLabel ProviderCollateral ClientCollateral StoragePricePerEpoch StartEpoch EndEpoch ClientPeerID DealDataRoot SignedProposalCid InboundFilePath ChainDealID PublishCid IsOffline Transfer { Type Size } IsTransferStalled Checkpoint Err Sector { ID Offset Length } Message } } }"}' \
http://localhost:8080/graphql/query | jq > boost_deals.json
```

### Importing Deals

Before starting to import deals, confirm whether the miner account is in the `venus` chain services. If not, migrate the miner account into the `venus` chain services.

```bash
./droplet actor list
```

1. Import Old Protocol Deals

```bash
./droplet storage deal import-deal boost_old_deals.json

# Result
import 2 deals success
```

2. Import New Protocol Deals

```bash
./droplet storage deal import-deal --from boost boost_deals.json

# Result
import 3 deals success
```

> --car-dirs Specify the directory for car files, multiple can be set: --car-dirs /tmp/cars --car-dirs /tmp/cars2, the program will obtain the deal payload size based on the piece cid

> payload size is used when generating indexes

If during the import process you encounter `deal bafyreih7qaddtjxu66khjohckd3gkp42p3x5i2fhw5xjw325rnb7wvje7q payload size 0`, it means that the `payload size` of some deals is `0`, and such deals will not be imported. You can solve this problem by setting `--car-dirs` to let the program obtain the `payload size` based on the `piece cid`.
