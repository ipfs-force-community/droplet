## Batch deal Placement

Batch offline deals can be placed using `droplet-client`.

Batch deal placement command: `droplet-client storage deals batch [command options] [miners price duration]`, the usage is similar to sending a single deal, with some additional options.

Some options:

* --miner The miner receiving the deal, can be multiple `--miner=t010001` `--miner=t010002`, multiple miners will distribute deals evenly.
* --manifest The `manifest.csv` file generated by `go-graphsplit`, containing information such as `payload cid`, `piece cid`, and `piece size`.
* --start-index Start from the Nth deal in `manifest.csv`.
* --end-index End at the Nth deal in `manifest.csv`, start-index - end-index is the expected total number of deals to be placed this time.
* --filter Whether to enable filtering, default is false. Currently, there are two filtering rules:
  * The duplicated data for a storage provider cannot exceed 20%.
  * The datacap deals from one deal placer to the same storage provider cannot exceed 25%.

## Examples

### Prepare deal Data

Use [go-graphsplit](https://github.com/filedrive-team/go-graphsplit#usage) to generate deal data. `go-graphsplit` is a tool for splitting large datasets into fixed-size car files.

```
# --car-dir Specify the directory to store the generated car files and manifest.csv file
# --slice-size Specify the car file size
# --graph-name The name of the graph, can be arbitrary
# --calc-commp Whether to calculate commp, must be calculated, offline deals require piece cid and piece size
# --rename The generated car files are named with payloadcid.car by default; adding this flag names them with piececid, recommended to add this flag for easier data import later
# path-to-source-file Specify the original data for generating car files

./graphsplit chunk --car-dir <car-dir> --slice-size <piece-size> --graph-name <name> --calc-commp --rename <path-to-source-file>

# Result
The car files and manifest.csv file will be generated in the specified directory
```

manifest.csv file content, which will be used during deal placement: playload_cid, piece_cid, payload_size, and payload_size.
```
playload_cid,filename,piece_cid,payload_size,payload_size,detail
bafybeib6kembdoggfwssslpcrxgpbhxmeyretwcnaspx5ff2r4rybt73gq,test-total-19-part-1.car,baga6ea4seaqevygou3u5mlxl6prwifaw2n4e6eanrbdl7wm2guzfm2r5tool4fi,14241759,16646144,"{""Name"":"""",""Hash"":""bafybeib6kembdoggfwssslpcrxgpbhxmeyretwcnaspx5ff2r4rybt73gq"",""Size"":0,""Link"":[{""Name"":""filecoin-ffi"",""Hash"":""bafybeibum5nzwz54733lioyzwhqrod2zauax2jaa4qiu5hdqw7fidzl47m"",""Size"":14240979,""Link"":[{""Name"":""libfilcrypto.a.00000001"",""Hash"":""bafybeigptobclymvmmlxn4n764dey2p6hgot6h34vtte5fzm67l2znwz4q"",""Size"":14240905,""Link"":null}]}]}"
bafybeihh6sq3w5qmzrxakde5wwjkw7wnbwwxm5yvfo3nd5zjw25vtgcqom,test-total-19-part-2.car,baga6ea4seaqh4vblymafqc3tskmy5jilgs462gsbvuu6mxnsql364bhbj5omcji,14241759,16646144,"{""Name"":"""",""Hash"":""bafybeihh6sq3w5qmzrxakde5wwjkw7wnbwwxm5yvfo3nd5zjw25vtgcqom"",""Size"":0,""Link"":[{""Name"":""filecoin-ffi"",""Hash"":""bafybeigiprvgstre4ctcwleocm2gg52hzc32ccnjr66phud5qrnbmjyqli"",""Size"":14240979,""Link"":[{""Name"":""libfilcrypto.a.00000002"",""Hash"":""bafybeia4fxflzrihwbjkjayasrtvmnocvq5xn3pesendcjnlog47fchd6q"",""Size"":14240905,""Link"":null}]}]}"
bafybeihw7afqagfvg2uhmigyunsgvxeidaqfbg6odi4jwbus6557kqhsd4,test-total-19-part-3.car,baga6ea4seaqij5nrrmypz22lchdrjcaowjdjk67agjntbcfbcbbrcrnrdbn7kfy,14241759,16646144,"{""Name"":"""",""Hash"":""bafybeihw7afqagfvg2uhmigyunsgvxeidaqfbg6odi4jwbus6557kqhsd4"",""Size"":0,""Link"":[{""Name"":""filecoin-ffi"",""Hash"":""bafybeicn4bdznskvsjt3on2633mm3uh5gungf37hmfhsizraugq4uleosu"",""Size"":14240979,""Link"":[{""Name"":""libfilcrypto.a.00000003"",""Hash"":""bafybeidi5kz5hhfwcqechj4czbyat3tlyyd4d6rigigkks66ysjy5agfke"",""Size"":14240905,""Link"":null}]}]}"
bafybeigq66gjr6c6junro7t4fwcpkhl7vpowi3soadksjvleusq6nlzu6a,test-total-19-part-4.car,baga6ea4seaqaamzryns5cphp5bynuq5nrxdltxzcj6hoybboduhh4377rw6lqgy,14241759,16646144,"{""Name"":"""",""Hash"":""bafybeigq66gjr6c6junro7t4fwcpkhl7vpowi3soadksjvleusq6nlzu6a"",""Size"":0,""Link"":[{""Name"":""filecoin-ffi"",""Hash"":""bafybeih5lopymib4lbnoonqatu43r2avm2rw2nz4eeva6zmnyyegjsoyma"",""Size"":14240979,""Link"":[{""Name"":""libfilcrypto.a.00000004"",""Hash"":""bafybeieo2dahkmiak4rlyfehpgu4gyjq2v6wulbmcobha3f2nk6ftysaae"",""Size"":14240905,""Link"":null}]}]}"
```

### Batch deal Placement

1. Place Regular Offline deals
```
./droplet-client storage deals batch --from <address> --manifest <path-to-manifest.csv> --end-index 10 --start-index 5 --miner=t019150 --miner=t018682 0 518400

# Result
has 5 deals need to publish, t018682: 3, t019150: 2
create deal success, proposal cid: bafyreihwvsr3vfsdbrxagtdjzsemngtc3r3xra2gaunbs6pjb63lyodl6a
create deal success, proposal cid: bafyreid2oakcs2di6lq5mv3e4h5sybkezl3zn7lhvf656zeqentcsqetem
create deal success, proposal cid: bafyreidmzdh7zee7inm65cdxmuwyxyv7uwtoo2hiphsjfseyymoir2z4nm
create deal success, proposal cid: bafyreigt663jymtilnxocfybs27w6b564yxfczdpsx47fbsqwzrj54zxz4
create deal success, proposal cid: bafyreigtemnxftqg65gtwsw3rwfvqaqzbb47d4r75ipksjlypcs56y7qei
```

2. Batch Place Datacap deals

> Please add the --verified-deal flag

```
./droplet-client storage deals batch --from <address> --manifest <path-to-manifest.csv> --end-index 15 --start-index 10 --verified-deal --miner=t019150 --miner=t018682 0 518400
```

### Query deals

1. Query a Single deal

```
./droplet-client storage deals get bafyreify4mm46vfdqsogcfhki44vi3ll5n2h35p5fflcclew53fgm3yieu
```

2. List All Offline deals

```
./droplet-client storage deals list --offline
```

### Batch Import deal Data

**Prerequisite: The car files generated by `go-graphsplit` are named with piececid.**

1. Export Pending Import Offline deals

You can export all deals in the `StorageDealWaitingForData` state, the exported data includes proposal cid and piece cid.

```
./droplet-client storage deals export --output proposal_piece.txt

cat proposal_piece.txt

proposalCID,pieceCID
bafyreihwvsr3vfsdbrxagtdjzsemngtc3r3xra2gaunbs6pjb63lyodl6a,baga6ea4seaqbj3yywnq3yisdxy4zlf4if2whlm5sdjcz7ricm2wrow2b7rc2uja
bafyreid2oakcs2di6lq5mv3e4h5sybkezl3zn7lhvf656zeqentcsqetem,baga6ea4seaqcdstiui27aajpz2dcpx2f6brimxhfvepgxljwsweicul32pkeofq
bafyreidmzdh7zee7inm65cdxmuwyxyv7uwtoo2hiphsjfseyymoir2z4nm,baga6ea4seaqlrwtnhj322vczuuiy2ekb4kjftbf3ho6f4bgy6k5rnzh67eia4lq
bafyreigt663jymtilnxocfybs27w6b564yxfczdpsx47fbsqwzrj54zxz4,baga6ea4seaqdgfsfsdtpnsgwlwhtj4ecvk7432gaqheltfrzun3vju3yc3d7cnq
bafyreigtemnxftqg65gtwsw3rwfvqaqzbb47d4r75ipksjlypcs56y7qei,
baga6ea4seaqknn4cstmtmscdhebaxmv5dopnxqthwbdmvuslbuv5dcupzvw46ni
```

2. Batch Import deal Data

```
# --cardir The directory of car files, if the car files are placed in piecestore in advance, this flag can be omitted. If you confirm the piece data is fine, you can use `--skip-commp` parameter to speed up the data import process.
./droplet storage deal batch-import-data --manifest <proposal_piece.txt> --car-dir <path-to-cardir>

# Result
import data success: bafyreihwvsr3vfsdbrxagtdjzsemngtc3r3xra2gaunbs6pjb63lyodl6a
import data success: bafyreid2oakcs2di6lq5mv3e4h5sybkezl3zn7lhvf656zeqentcsqetem
import data success: bafyreidmzdh7zee7inm65cdxmuwyxyv7uwtoo2hiphsjfseyymoir2z4nm
import data success: bafyreigt663jymtilnxocfybs27w6b564yxfczdpsx47fbsqwzrj54zxz4
import data success: bafyreigtemnxftqg65gtwsw3rwfvqaqzbb47d4r75ipksjlypcs56y7qei
```

### Query Proportion Statistics

1. View Storage Provider deal Duplication

```
./droplet-client storage deals verified-deal-stat --provider t019150

# Result
Provider  Total      Uniq       DuplicationPercentage  
t019150   981467136  612368384  37.61% 
```

2. View Sample Distribution

```
./droplet-client storage deals verified-deal-stat --client t3wivhkdivcxj5zp2l4wjkzon232s52smnd5m3na66ujl5nel75jggguhgaa3zbhjo3as4epf5ytxl6ly3qoha

# Result
Client: t3wivhkdivcxj5zp2l4wjkzon232s52smnd5m3na66ujl5nel75jggguhgaa3zbhjo3as4epf5ytxl6ly3qoha
Total:  16.17 GiB / 17362337792 B
Uniq:   14.77 GiB / 15860764672 B
DuplicationPercentage: 8.65%
Provider  Total                      Percentage  Uniq                       DuplicationPercentage  
t019150   620 MiB / 650117120 B      3.74%       620 MiB / 650117120 B      0.00%                  
t018682   15.56 GiB / 16712220672 B  96.26%      14.42 GiB / 15487471616 B  7.33%  
```
